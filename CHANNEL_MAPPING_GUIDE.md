# 通道名称映射说明

## 问题

多次运行下载脚本时，如何确保同一个摄像头的视频始终保存在同一个文件夹中？

## 解决方案

脚本现在使用 **持久化通道映射** 机制，自动解决这个问题！

## 工作流程

### 首次运行

1. 脚本扫描NVR，发现有录像的通道
2. 尝试从NVR获取每个通道的名称（通过ISAPI接口）
3. 将通道号→名称的映射保存到 `channel_mapping.json`
4. 使用摄像头名称作为文件夹名（如"监控04_jiankong"）

```
media/
└── 10.19.2.2/
    ├── 监控04_jiankong/      ← 使用NVR中设置的名称
    ├── 监控08_jiankong/
    ├── channel_02/           ← 如果NVR没有设置名称，使用通道号
    └── channel_mapping.json  ← 映射文件
```

### 后续运行

1. 自动读取 `channel_mapping.json`
2. 使用相同的文件夹名称
3. **保证同一摄像头永远在同一文件夹** ✅

## channel_mapping.json 格式

```json
{
  "1": "大门入口",
  "2": "停车场",
  "4": "监控04_jiankong",
  "8": "监控08_jiankong"
}
```

- **键**：通道号（字符串格式）
- **值**：摄像头名称

## 自定义通道名称

### 方法1：在NVR中设置

在NVR的Web管理界面中为每个通道设置名称，脚本会自动获取。

### 方法2：手动编辑映射文件

1. 首次运行脚本后，找到映射文件：
   ```
   media/10.19.2.2/channel_mapping.json
   ```

2. 使用文本编辑器打开并编辑：
   ```json
   {
     "1": "大门入口",
     "2": "停车场",
     "3": "前台大厅",
     "4": "办公室走廊",
     "8": "仓库"
   }
   ```

3. 保存文件

4. **重要**：建议在首次运行后立即编辑，确定好名称后再进行大量下载

## 示例对比

### 没有映射（旧版本）
```
media/10.19.2.2/
├── channel_01/
├── channel_04/
└── channel_08/
```
❌ 无法知道哪个文件夹对应哪个摄像头

### 有映射（新版本）
```
media/10.19.2.2/
├── 大门入口/          ← 清晰明了
├── 监控04_jiankong/   ← 清晰明了
└── 监控08_jiankong/   ← 清晰明了
```
✅ 一目了然，永久对应

## 注意事项

1. **首次设置很重要**
   - 在首次运行后立即检查 `channel_mapping.json`
   - 确定好名称后再进行大量下载

2. **修改名称的影响**
   - 修改名称后，新视频会保存到新文件夹
   - 旧视频不会自动移动
   - 需要手动移动或重命名文件夹

3. **映射文件丢失**
   - 如果删除了 `channel_mapping.json`
   - 脚本会重新尝试从NVR获取名称
   - 如果NVR中没有设置名称，会退回到使用 `channel_XX` 格式

4. **文件夹名称规则**
   - 会自动清理不安全的字符（如 `/`, `\`, `..` 等）
   - 保证文件夹名称的安全性

## 快速开始

```powershell
# 1. 设置环境变量
$env:HIK_USERNAME = 'admin'
$env:HIK_PASSWORD = 'your_password'

# 2. 首次运行（短时间测试）
python media_download_all_channels.py 10.19.2.2 2024-11-25 08:00:00 2024-11-25 08:30:00

# 3. 检查生成的文件夹和映射文件
dir media\10.19.2.2
type media\10.19.2.2\channel_mapping.json

# 4. 如需要，编辑 channel_mapping.json 自定义名称

# 5. 开始正式下载
python media_download_all_channels.py 10.19.2.2 2024-11-25 00:00:00 2024-11-25 23:59:59
```

## 优势总结

✅ **自动化**：首次运行自动创建映射
✅ **持久化**：映射永久保存，多次运行一致
✅ **可自定义**：支持手动编辑通道名称
✅ **清晰明了**：使用有意义的名称代替通道号
✅ **安全可靠**：文件名安全处理，防止路径注入

不再担心多次下载时文件夹混乱的问题！🎉
